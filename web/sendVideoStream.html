<!-- index.html (sender) -->
<!DOCTYPE html>
<html>
  <head>
    <title>Webcam Stream</title>
  </head>
  <body>
    <h1>Streaming Host</h1>
    <h2 id="user_id"></h2>
    <video id="video" autoplay></video>

    <script>
      const video = document.getElementById("video");
      const canvas = document.createElement("canvas");
      const ws = new WebSocket("ws://localhost:8765");
      const userIdElement = document.getElementById("user_id");
      const userId = (Math.random() + 1).toString(36).substring(2);
      userIdElement.innerHTML = `ID: ${userId}`;

      // Access the webcam
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
        })
        .catch((err) => {
          console.error("Error accessing the webcam: ", err);
        });

      // Capture video frames and send them to the server
      video.addEventListener("play", () => {
        const context = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        function sendFrame() {
          console.log("sending message");
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          canvas.toBlob((blob) => {
            ws.send(blob);
          }, "image/jpeg");
        }

        setInterval(() => {
          sendFrame();
        }, 300); // Send frames every 100ms
      });

      ws.onopen = (websocket) => {
        console.log("WebSocket connection opened", websocket);
      };

      ws.onclose = () => {
        console.log("WebSocket connection closed");
      };
    </script>
  </body>
</html>
